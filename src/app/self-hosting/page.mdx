import { defaultKeywords, defaultOpenGraph } from '../metadata'

export const metadata = {
  title: 'Self-Hosting',
  description: 'This guide explains how to self-host TofuPilot.',
  keywords: [
    ...defaultKeywords,
    'Self-Hosting',
    'TofuPilot Deployment',
    'Docker Setup',
    'On-Premise Installation',
    'Enterprise Hosting',
  ],
  openGraph: {
    ...defaultOpenGraph,
    title:
      'Self-Hosting - Deploy TofuPilot On-Premise | TofuPilot Documentation',
    description:
      'Learn how to self-host TofuPilot for on-premise deployment. Includes setup, authentication, and backup guidelines.',
    images: [
      {
        url: 'https://tofupilot.com/docs/self-hosting-header.png',
        width: 800,
        height: 600,
        alt: 'Self-hosting header showing TofuPilot deployed on a private server.',
      },
    ],
  },
}

# Self-Hosting

Self-host TofuPilot for scenarios where managed cloud is not an option. {{ className: 'lead' }}

<Image
  src="/self-hosting-header.png"
  alt="Screenshot of TofuPilot application with custom url"
/>

## Overview

TofuPilot accounts are hosted on our AWS-powered cloud, managed by our team. This ensures strong security, high performance, automatic updates, and removes the need for your infrastructure management.

For strict IT policies or specific connectivity needs, TofuPilot can also be self-hosted.

## Prerequisites

### System Requirements

Ensure your server meets the minimum specifications.

- **OS**: Ubuntu 20.04 LTS or later (64-bit)
- **CPU**: 2 cores or more
- **RAM**: 4 GB or more
- **Storage**: 20 GB of free disk space, or more depending on your run attachments needs
- **Access**: Sudo access to your server.
- **Network**: Open ports 80 (HTTP) and 443 (HTTPS)

### Domains

Ensure your domain and DNS settings are prepared for self-hosting:

- **Domain Name**: Register a domain or subdomain for TofuPilot (e.g., `tofupilot.yourcompany.com`).
- **Storage Domain Name**: Register a subdomain for TofuPilot storage (e.g., `storage.tofupilot.yourcompany.com`).
- **DNS Records**: Create two A records in your DNS settings:
  - Point `tofupilot.yourcompany.com` to your server's public IPv4 address.
  - Point `storage.tofupilot.yourcompany.com` to the same public IPv4 address.
- **SSL Certificate**: Ensure you have a valid email address for registering the SSL certificate with Let’s Encrypt.

## Authentication

TofuPilot does not store user passwords in its database and offers two secure methods for user sign-up and authentication:

1. **Email Authentication**: Users sign in by receiving a magic code sent to their email.
2. **OAuth Authentication**: Users sign in using their Microsoft or Google accounts.

You must enable **at least one** authentication method based on your requirements.

### Email

To enable email-based authentication, retrieve the following SMTP server details:

- **SMTP Host**: The hostname of your email server (e.g., `smtp.yourdomain.com`).
- **SMTP Port**: Typically `587` for TLS or `465` for SSL.
- **Email From Address**: The email address that will send the magic codes (e.g., `auth@yourdomain.com`).
- **SMTP User**: The username for your email account (e.g., `auth@yourdomain.com`).
- **SMTP Password**: The password or app-specific password for your email account.

To enable OAuth authentication, create an authorized application in your Google or Microsoft account:

### Microsoft Entra ID OAuth

1. Go to the [Microsoft Entra admin center](https://entra.microsoft.com/).
2. Navigate to **Microsoft Entra ID** > Manage > **App registrations**.
3. Register a new application with these details:
   - **Redirect URI**: e.g. `https://tofupilot.yourcompany.com/api/auth/callback/microsoft-entra-id`
   - Set **Supported Account Types** to match your needs (e.g., single tenant or multi-tenant).
4. After registration, retrieve the following:
   - **Application (client) ID**
   - **Directory (tenant) ID**
   - **Client Secret**: Create a client secret under **Certificates & secrets**.

### Google OAuth

1. Go to the [Google Cloud Console](https://console.developers.google.com/apis/credentials).
2. Create a new OAuth 2.0 Client ID under **Credentials**.
3. Configure the following:
   - **Authorized Redirect URI**: `https://tofupilot.yourcompany.com/api/auth/callback/google`
4. Retrieve the following:
   - **Client ID**
   - **Client Secret**

## Deploy

TofuPilot provides a one-line installer that automatically handles all dependencies and configuration.

### Installation

1. **SSH into your server:**

   Connect to your server via its IP address using SSH, or [Putty](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html) on Windows:

   <Code
    language="bash"
    code={`ssh user@your_server_ip`}
    />

2. **Run the installer:**

   The installer will automatically install Docker, Docker Compose, and all required dependencies:

   <Code
     language="bash"
     code={`curl -fsSL https://tofupilot.sh/install | bash`}
   />

### Configuration Prompts

The installer will prompt you for the following information:

<Code
  language="bash"
  code={`Domain name [tofupilot.example.com]: tofupilot.yourcompany.com
Storage domain [storage.tofupilot.yourcompany.com]: storage.tofupilot.yourcompany.com
SSL certificate email [admin@tofupilot.yourcompany.com]: admin@yourcompany.com

# SSL Configuration
SSL mode [letsencrypt]: letsencrypt

# Authentication (choose at least one)
Configure Google OAuth? [y/N]: y
  Google OAuth Client ID: your-google-client-id
  Google OAuth Client Secret: ***hidden***

Configure Microsoft Entra ID? [y/N]: n

Configure SMTP email? [y/N]: y
  SMTP server hostname: smtp.gmail.com
  SMTP port [587]: 587
  SMTP username: your-email@gmail.com
  SMTP password: ***hidden***
  From email address [tofupilot@tofupilot.yourcompany.com]: noreply@yourcompany.com`}
/>


## Post-Installation

Once the script finishes, access the web app at `https://tofupilot.yourcompany.com` to create an admin account, and set up an organization (we recommend naming it `app`).

You can upload test runs using the public TofuPilot Python package. Simply set your instance URL with the `url` parameter as shown below. All features described in the rest of the documentation will function as expected.

<CodeGroup>
    <Code title="OpenHTF" language="python" code={`import openhtf as htf
from tofupilot.openhtf import TofuPilot

def main():
        test = htf.Test(
              procedure_id="FVT1",
              part_number="PCB1",
              )

with TofuPilot(test, url="https://tofupilot.yourcompany.com"): # specify URL here
        test.execute(lambda: "PCB1A001")

if __name__ == '__main__':
        main()
    `} />


    <Code title="Vanilla Python" language="python" code={`from tofupilot import TofuPilotClient
  from datetime import datetime, timedelta

  def main():
      client = TofuPilotClient(url="https://tofupilot.yourcompany.com") # specify URL here

      client.create_run(
          procedure_id="FVT1",
          run_passed=True,
          unit_under_test={
                "serial_number": "PCB1A001",
                "part_number": "PCB1"},
          duration=timedelta(minutes=1, seconds=45),
      )

  if __name__ == '__main__':
      main()`}  />

</CodeGroup>

## Update

To update your self-hosted TofuPilot app to the latest version:

<Code
  language="bash"
  code={`curl -fsSL https://tofupilot.sh/install | bash -s -- --update`}
/>

Alternatively, you can manually update using Docker Compose:

<Code
  language="bash"
  code={`docker compose down && docker compose up -d --pull always`}
/>

## Backups

Ensure the following Docker volumes are included in your backup routine:

### **Volumes to Back Up**

- **`database-data`**:
  Contains all database files, including schema definitions, configurations, and application data. Backup this volume to preserve your database's state and integrity.

- **`storage-data`**:
  Stores user-uploaded files such as profile pictures, attachments, and other assets. Backup this volume to safeguard external content and binary data.

### **Backup Recommendations**

Integrate these volumes into your backup process using methods like volume snapshots, off-site replication, or encrypted storage to ensure data durability and smooth recovery in case of failure or migration.

## Advanced Installation Options

The installer supports several options for different use cases:

### Development Mode

For development installations with the latest features:

<Code
  language="bash"
  code={`curl -fsSL https://tofupilot.sh/install | bash -s -- --dev`}
/>

### Custom Configuration

To use a pre-configured environment file:

<Code
  language="bash"
  code={`curl -fsSL https://tofupilot.sh/install | bash -s -- --env-file /path/to/custom.env`}
/>

### Service Management

Check deployment status:

<Code
  language="bash"
  code={`curl -fsSL https://tofupilot.sh/install | bash -s -- --status`}
/>

View logs:

<Code
  language="bash"
  code={`curl -fsSL https://tofupilot.sh/install | bash -s -- --logs`}
/>

Restart services:

<Code
  language="bash"
  code={`curl -fsSL https://tofupilot.sh/install | bash -s -- --restart`}
/>

### Uninstall

To completely remove TofuPilot:

<Code
  language="bash"
  code={`curl -fsSL https://tofupilot.sh/install | bash -s -- --uninstall`}
/>

## Troubleshooting

### ARM64 Architecture (Apple Silicon)

If you encounter "exec format error" on ARM64 systems:

1. **Docker Desktop (Mac)**: Enable Rosetta emulation
   - Docker Desktop → Settings → General → Use Rosetta for x86/amd64 emulation

2. **Install QEMU emulators**:
   <Code
     language="bash"
     code={`docker run --rm --privileged tonistiigi/binfmt --install all`}
   />

### Port Conflicts

If ports 80/443 are in use, check running services:

<Code
  language="bash"
  code={`sudo netstat -tlnp | grep -E ':80|:443'`}
/>

### SSL Certificate Issues

If HTTPS is not working immediately after installation:

- SSL certificates may take a few minutes to generate
- Check certificate status: `curl -I https://tofupilot.yourcompany.com`
- Verify DNS records point to your server's IP address

### Service Status

Check if all services are running properly:

<Code
  language="bash"
  code={`docker compose ps`}
/>

View service logs:

<Code
  language="bash"
  code={`docker compose logs -f`}
/>

## Digital Ocean Installation Tutorial

This step-by-step guide walks you through deploying TofuPilot on a Digital Ocean droplet.

### Step 1: Create a Digital Ocean Droplet

1. **Sign up for Digital Ocean** at [cloud.digitalocean.com](https://cloud.digitalocean.com/registrations/new)

2. **Create a new Droplet:**
   - Choose **Ubuntu 22.04 LTS** as the operating system
   - Select **Basic** plan with at least **2 GB RAM / 1 vCPU** ($12/month)
   - Choose a datacenter region close to your users
   - Add your SSH key for secure access
   - Name your droplet (e.g., "tofupilot-server")

3. **Configure Firewall** (recommended):
   - Create a new firewall rule
   - Allow inbound traffic on ports: **22 (SSH)**, **80 (HTTP)**, **443 (HTTPS)**
   - Apply the firewall to your droplet

### Step 2: Set Up Domain Configuration

You have two options for domain configuration:

#### Option A: Using Your Own Domain (Recommended for Production)

1. **Get your droplet's IP address** from the Digital Ocean dashboard
2. **Add DNS records** in your domain provider:
   - **A record**: `tofupilot.yourcompany.com` → `your_droplet_ip`
   - **A record**: `storage.tofupilot.yourcompany.com` → `your_droplet_ip`

#### Option B: Using nip.io (Quick Testing/Development)

If you don't have a domain name or want to test quickly, you can use nip.io:

1. **Get your droplet's IP address** (e.g., `167.99.123.45`)
2. **Use nip.io domains** that automatically resolve to your IP:
   - Main domain: `tofupilot.167.99.123.45.nip.io`
   - Storage domain: `storage.167.99.123.45.nip.io`

**Note**: Replace `167.99.123.45` with your actual droplet IP address. nip.io automatically resolves any subdomain to the IP address embedded in the domain name.

### Step 3: Connect to Your Droplet

<Code
  language="bash"
  code={`ssh root@your_droplet_ip`}
/>

### Step 4: Install TofuPilot

Run the one-line installer:

<Code
  language="bash"
  code={`curl -fsSL https://tofupilot.sh/install | bash`}
/>

### Step 5: Configure TofuPilot

The installer will prompt you for configuration. Choose the example based on your domain setup:

#### Using Your Own Domain:
<Code
  language="bash"
  code={`Domain name [tofupilot.example.com]: tofupilot.yourcompany.com
Storage domain [storage.tofupilot.yourcompany.com]: storage.tofupilot.yourcompany.com
SSL certificate email [admin@tofupilot.yourcompany.com]: admin@yourcompany.com

# SSL Configuration (Let's Encrypt recommended)
SSL mode [letsencrypt]: letsencrypt

# Configure at least one authentication method
Configure Google OAuth? [y/N]: y
  Google OAuth Client ID: your-google-client-id
  Google OAuth Client Secret: ***hidden***

Configure Microsoft Entra ID? [y/N]: n

Configure SMTP email? [y/N]: y
  SMTP server hostname: smtp.gmail.com
  SMTP port [587]: 587
  SMTP username: your-email@gmail.com
  SMTP password: ***hidden***
  From email address [tofupilot@tofupilot.yourcompany.com]: noreply@yourcompany.com`}
/>

#### Using nip.io (replace 167.99.123.45 with your droplet IP):
<Code
  language="bash"
  code={`Domain name [tofupilot.example.com]: tofupilot.167.99.123.45.nip.io
Storage domain [storage.tofupilot.167.99.123.45.nip.io]: storage.167.99.123.45.nip.io
SSL certificate email [admin@tofupilot.167.99.123.45.nip.io]: your-email@gmail.com

# SSL Configuration (Let's Encrypt works with nip.io)
SSL mode [letsencrypt]: letsencrypt

# Configure at least one authentication method
Configure Google OAuth? [y/N]: y
  Google OAuth Client ID: your-google-client-id
  Google OAuth Client Secret: ***hidden***

Configure Microsoft Entra ID? [y/N]: n

Configure SMTP email? [y/N]: y
  SMTP server hostname: smtp.gmail.com
  SMTP port [587]: 587
  SMTP username: your-email@gmail.com
  SMTP password: ***hidden***
  From email address [tofupilot@tofupilot.167.99.123.45.nip.io]: your-email@gmail.com`}
/>

### Step 6: Verify Installation

1. **Check service status:**
   <Code
     language="bash"
     code={`docker compose ps`}
   />

2. **Test HTTPS access:**
   
   For your own domain:
   <Code
     language="bash"
     code={`curl -I https://tofupilot.yourcompany.com`}
   />
   
   For nip.io (replace with your IP):
   <Code
     language="bash"
     code={`curl -I https://tofupilot.167.99.123.45.nip.io`}
   />

3. **Access your TofuPilot instance:**
   - Own domain: `https://tofupilot.yourcompany.com`
   - nip.io: `https://tofupilot.167.99.123.45.nip.io` (replace with your IP)

### Digital Ocean Specific Tips

**Firewall Configuration:**
- Ensure your Digital Ocean firewall allows HTTP (80) and HTTPS (443)
- You can manage this in the Digital Ocean dashboard under Networking > Firewalls

**Monitoring:**
- Enable monitoring in your droplet settings for CPU, memory, and disk usage
- Set up alerts for high resource usage

**Backups:**
- Enable automatic backups for your droplet ($2.40/month for a $12/month droplet)
- Consider creating snapshots before major updates

**Scaling:**
- Start with a $12/month droplet (2GB RAM) for small teams
- Upgrade to $24/month (4GB RAM) or higher for larger deployments
- You can resize your droplet from the Digital Ocean dashboard

**Cost Estimation:**
- Basic droplet: $12/month
- Automatic backups: $2.40/month
- Total: ~$15/month for a small TofuPilot deployment
